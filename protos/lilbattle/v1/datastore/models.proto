syntax = "proto3";

package lilbattle.v1;

import "dal/v1/annotations.proto";
import "lilbattle/v1/models/models.proto";
import "google/protobuf/any.proto";
import "google/protobuf/struct.proto";

option go_package = "github.com/turnforge/lilbattle/gen/datastore;lilbattledatastore";

// Supporting types that are referenced by main entities

message IndexInfoDatastore {
  option (dal.v1.datastore_options) = { source: "lilbattle.v1.IndexInfo" };
}

message TileDatastore {
  option (dal.v1.datastore_options) = { source: "lilbattle.v1.Tile" };
}

message CrossingDatastore {
  option (dal.v1.datastore_options) = { source: "lilbattle.v1.Crossing" };
}

message UnitDatastore {
  option (dal.v1.datastore_options) = { source: "lilbattle.v1.Unit" };

  // Attack history as nested entities (noindex for large arrays)
  repeated AttackRecordDatastore attack_history = 1 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];
}

message AttackRecordDatastore {
  option (dal.v1.datastore_options) = { source: "lilbattle.v1.AttackRecord" };
}

// WorldDatastore is the Datastore representation for World
message WorldDatastore {
  option (dal.v1.datastore_options) = {
    source: "lilbattle.v1.World"
    kind: "World"
  };

  string id = 1 [(dal.v1.column) = {
    datastore_tags: ["-"]
  }];

  // Tags as noindex (not queryable)
  repeated string tags = 2 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];

  // PreviewUrls as noindex
  repeated string preview_urls = 3 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];

  // DefaultGameConfig as flattened embedded struct
  GameConfigurationDatastore default_game_config = 4 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];

  // SearchIndexInfo - needs_indexing should be indexed for worker queries
  IndexInfoDatastore search_index_info = 5 [(dal.v1.column) = {
    datastore_tags: ["flatten"]
  }];
}

// WorldDataDatastore stores the actual world map data
message WorldDataDatastore {
  option (dal.v1.datastore_options) = {
    source: "lilbattle.v1.WorldData"
    kind: "WorldData"
  };

  // Primary key - matches World.id (excluded from properties, used for key)
  string world_id = 1 [(dal.v1.column) = {
    datastore_tags: ["-"]
  }];

  // Map of tiles - large, no index needed
  map<string, TileDatastore> tiles_map = 2 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];

  // Map of units - large, no index needed
  map<string, UnitDatastore> units_map = 3 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];

  // Map of crossings - large, no index needed
  map<string, CrossingDatastore> crossings = 4 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];

  // ScreenshotIndexInfo - flatten so needs_indexing is queryable
  IndexInfoDatastore screenshot_index_info = 5 [(dal.v1.column) = {
    datastore_tags: ["flatten"]
  }];
}

// GameDatastore is the Datastore representation for Game
message GameDatastore {
  option (dal.v1.datastore_options) = {
    source: "lilbattle.v1.Game"
    kind: "Game"
  };

  // ID - used for key, not stored as property
  string id = 1 [(dal.v1.column) = {
    datastore_tags: ["-"]
  }];

  // World ID - indexed for filtering games by world
  string world_id = 2;

  // Tags as noindex (not queryable)
  repeated string tags = 3 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];

  // PreviewUrls as noindex
  repeated string preview_urls = 4 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];

  // Config as noindex (large nested struct)
  GameConfigurationDatastore config = 5 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];

  // SearchIndexInfo - flatten so needs_indexing is queryable
  IndexInfoDatastore search_index_info = 6 [(dal.v1.column) = {
    datastore_tags: ["flatten"]
  }];
}

// GameStateDatastore stores the active game state
message GameStateDatastore {
  option (dal.v1.datastore_options) = {
    source: "lilbattle.v1.GameState"
    kind: "GameState"
  };

  // GameId - used for key, not stored as property
  string game_id = 1 [(dal.v1.column) = {
    datastore_tags: ["-"]
  }];

  // WorldData - large embedded struct, noindex
  WorldDataDatastore world_data = 2 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];

  // Per-player runtime state - noindex
  map<int32, PlayerStateDatastore> player_states = 3 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];
}

message GameConfigurationDatastore {
  option (dal.v1.datastore_options) = { source: "lilbattle.v1.GameConfiguration" };

  // Players as noindex nested array
  repeated GamePlayerDatastore players = 1 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];

  // Teams as noindex nested array
  repeated GameTeamDatastore teams = 2 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];

  // IncomeConfigs embedded
  IncomeConfigDatastore income_configs = 3;

  // Settings embedded
  GameSettingsDatastore settings = 4;
}

message IncomeConfigDatastore {
  option (dal.v1.datastore_options) = { source: "lilbattle.v1.IncomeConfig" };
}

message GamePlayerDatastore {
  option (dal.v1.datastore_options) = { source: "lilbattle.v1.GamePlayer" };
}

message GameTeamDatastore {
  option (dal.v1.datastore_options) = { source: "lilbattle.v1.GameTeam" };
}

message GameSettingsDatastore {
  option (dal.v1.datastore_options) = { source: "lilbattle.v1.GameSettings" };

  // AllowedUnits as noindex (array of ints)
  repeated int32 allowed_units = 1 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];
}

message PlayerStateDatastore {
  option (dal.v1.datastore_options) = { source: "lilbattle.v1.PlayerState" };
}

// GameMoveDatastore stores individual moves
message GameMoveDatastore {
  option (dal.v1.datastore_options) = {
    source: "lilbattle.v1.GameMove"
    kind: "GameMove"
  };

  // Fields needed for composite key and querying
  string game_id = 1;

  // Group number - indexed for range queries
  int64 group_number = 2;

  // Move number within group - indexed for ordering
  int64 move_number = 3;

  // Field named "move_type" matches the oneof name in source
  // This automatically skips all oneof members (move_unit, attack_unit, etc.)
  // Stored as bytes, noindex (too large)
  google.protobuf.Any move_type = 4 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];

  // Changes - stored as bytes array, noindex (too large)
  repeated google.protobuf.Any changes = 5 [(dal.v1.column) = {
    datastore_tags: ["noindex"]
  }];
}
