<!-- templates/GameViewerPageMobile.html -->
{{# include "BasePage.html" #}}
{{# include "GameViewerHeaderButtons.html" #}}
{{# include "UnitStatsPanel.html" #}}
{{# include "TerrainStatsPanel.html" #}}
{{# include "DamageDistributionPanel.html" #}}
{{# include "TurnOptionsPanel.html" #}}
{{# include "panels/GameLogPanel.html" #}}

{{ define "ExtraHeaderButtons" }}
<div class="flex items-center space-x-2">
    {{ template "GameViewerHeaderButtons" }}
</div>
{{ end }}

{{ define "ExtraHeadSection" }}
<style>
    /* Mobile-specific styles */
    html, body {
        overflow: hidden;
        height: 100%;
        margin: 0;
        padding: 0;
    }

    /* Main container takes full viewport, uses flexbox */
    #mobile-game-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
    }

    /* Compact Summary Card - fixed height */
    #mobile-compact-summary-card {
        @apply bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-3;
        position: absolute;
        left: 0px;
        right: 0px;
        height: 56px;
        top: 66px;
        /*
        flex-shrink: 0;
        display: flex;
        align-items: center;
        min-height: 56px;
        max-height: 56px;
        */
    }

    /* Game Scene fills remaining space (header is 70px, bottom bar is 64px, card initially hidden) */
    #mobile-game-scene-container {
        @apply relative bg-gray-900;
        overflow: hidden;
        height: calc(100vh - 70px - 64px); /* viewport - header - bottom bar */
    }

    /* When compact card is visible, adjust game scene height */
    #mobile-compact-summary-card:not(.hidden) ~ #mobile-game-scene-container {
        height: calc(100vh - 70px - 64px); /* viewport - header - card - bottom bar */
    }

    #game-viewer-scene {
        @apply w-full h-full;
    }

    /* Bottom Action Bar - fixed at bottom, above game scene */
    #mobile-bottom-bar {
        @apply bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700;
        @apply flex items-center justify-around;
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 64px;
        z-index: 100;
    }

    .bottom-bar-button {
        @apply flex flex-col items-center justify-center px-4 py-2;
        @apply text-gray-600 dark:text-gray-400;
        @apply hover:text-gray-900 dark:hover:text-gray-100;
        @apply transition-colors duration-200;
        min-width: 60px;
        position: relative;
    }

    /* Highlighted button when drawer is open */
    .bottom-bar-button.active {
        @apply text-blue-600 dark:text-blue-400;
    }

    .bottom-bar-button.active::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 3px;
        background: currentColor;
        border-radius: 0 0 2px 2px;
    }

    /* Drawer Styles - overlays game scene, slides up from behind bottom bar */
    .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 50;
        pointer-events: none;
    }

    .drawer-overlay.open {
        pointer-events: auto;
    }

    .drawer-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0);
        transition: background 300ms ease-out;
    }

    .drawer-overlay.open .drawer-backdrop {
        background: rgba(0, 0, 0, 0.5);
    }

    .drawer-container {
        @apply bg-white dark:bg-gray-800;
        @apply rounded-t-xl shadow-2xl;
        position: absolute;
        bottom: 0px; /* Align with top of bottom bar */
        left: 0;
        right: 0;
        height: calc(70vh - 64px); /* Subtract bottom bar height */
        max-height: calc(70vh - 64px);
        transform: translateY(100%);
        transition: transform 300ms cubic-bezier(0.4, 0, 0.2, 1);
        touch-action: pan-y; /* Enable vertical swipe gestures */
    }

    .drawer-overlay.open .drawer-container {
        transform: translateY(0);
        bottom: 96px; /* Align with top of bottom bar */
    }

    .drawer-content {
        @apply overflow-y-auto;
        height: 100%;
        box-sizing: border-box;
    }

    .drawer-close-btn {
        @apply absolute top-2 right-2 p-2;
        @apply text-gray-400 hover:text-gray-600 dark:hover:text-gray-200;
        @apply transition-colors;
    }

    /* Loading overlay */
    #game-loading {
        @apply absolute inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 z-50;
    }
</style>
{{ end }}

{{ define "BodySection" }}
    <input id="gameIdInput" value="{{ .GameId }}" type="hidden" />
    <input id="playerCount" value="{{ .PlayerCount }}" type="hidden" />
    <input id="maxTurns" value="{{ .MaxTurns }}" type="hidden" />

    <!-- Mobile Game Container -->
    <div id="mobile-game-container">
        <!-- Compact Summary Card -->
        <div id="mobile-compact-summary-card" class="hidden">
            <!-- Content injected by presenter via setCompactSummaryCard() -->
        </div>

        <!-- Game Scene -->
        <div id="mobile-game-scene-container">
            <!-- Loading Overlay -->
            <div id="game-loading" class="absolute inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 z-50">
                <div class="text-center">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
                    <p class="text-white text-lg">Loading Game...</p>
                </div>
            </div>

            <!-- Phaser Game Container -->
            <div id="game-viewer-scene"></div>
        </div>

        <!-- Bottom Action Bar -->
        <div id="mobile-bottom-bar" class="bg-white dark:bg-gray-800">
            <!-- Buttons dynamically rendered by GameViewerPageMobile.ts -->
        </div>
    </div>

    <!-- Drawer Overlays -->

    <!-- Unit Stats Drawer -->
    <div id="mobile-drawer-unit-stats" class="drawer-overlay">
        <div class="drawer-backdrop"></div>
        <div class="drawer-container">
            <button class="drawer-close-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="drawer-content"> {{ template "UnitStatsPanel" }} </div>
        </div>
    </div>

    <!-- Terrain Stats Drawer -->
    <div id="mobile-drawer-terrain-stats" class="drawer-overlay">
        <div class="drawer-backdrop"></div>
        <div class="drawer-container">
            <button class="drawer-close-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="drawer-content"> {{ template "TerrainStatsPanel" }} </div>
        </div>
    </div>

    <!-- Damage Distribution Drawer -->
    <div id="mobile-drawer-damage-distribution" class="drawer-overlay">
        <div class="drawer-backdrop"></div>
        <div class="drawer-container">
            <button class="drawer-close-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="drawer-content">{{ template "DamageDistributionPanel" }}</div>
        </div>
    </div>

    <!-- Turn Options Drawer -->
    <div id="mobile-drawer-turn-options" class="drawer-overlay">
        <div class="drawer-backdrop"></div>
        <div class="drawer-container">
            <button class="drawer-close-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="drawer-content"> {{ template "TurnOptionsPanel" }} </div>
        </div>
    </div>

    <!-- Game Log Drawer -->
    <div id="mobile-drawer-game-log" class="drawer-overlay">
        <div class="drawer-backdrop"></div>
        <div class="drawer-container">
            <button class="drawer-close-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="drawer-content"> {{ template "GameLogPanel" }} </div>
        </div>
    </div>

    <!-- Game State Drawer -->
    <div id="mobile-drawer-game-state" class="drawer-overlay">
        <div class="drawer-backdrop"></div>
        <div class="drawer-container">
            <button class="drawer-close-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="drawer-content">
                <!-- Content will be injected by presenter via SetGameStatePanelContent -->
            </div>
        </div>
    </div>

    <!-- Build Options Modal (same as other variants) -->
    <div id="build-options-modal" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="modal-content relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">
                    üèóÔ∏è Build Unit
                </h2>
                <button class="cancel-button text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Modal Body (scrollable) -->
            <div class="modal-body flex-1 overflow-y-auto px-6 py-4">
                <!-- Content will be injected here by BuildOptionsModal component -->
            </div>

            <!-- Modal Footer -->
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                <button class="cancel-button px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden World Data for Frontend -->
    <pre id="game.data-json" style="display: none;">{{ if .Game }}{{ .Game | ToJson }}{{ else }}null{{ end }}</pre>
    <pre id="game-state-data-json" style="display: none;">{{ if .GameState }}{{ .GameState | ToJson }}{{ else }}null{{ end }}</pre>
    <pre id="game-history-data-json" style="display: none;">{{ if .GameHistory }}{{ .GameHistory | ToJson }}{{ else }}null{{ end }}</pre>
    <pre id="viewer-user-id" style="display: none;">{{ .Header.LoggedInUserId }}</pre>

    <!-- Hidden Rules Engine Data for Frontend -->
    <pre id="terrain-data-json" style="display: none;">{{ .GetTerrainDataJSON }}</pre>
    <pre id="unit-data-json" style="display: none;">{{ .GetUnitDataJSON }}</pre>
    <pre id="terrain-unit-properties-json" style="display: none;">{{ .GetTerrainUnitPropertiesJSON }}</pre>
    <pre id="unit-unit-properties-json" style="display: none;">{{ if 0 }} {{ .GetUnitUnitPropertiesJSON }} {{ end }}</pre>
{{ end }}

{{ define "PostBodySection" }}
<!-- WASM and Game Scripts -->
<script src="{{.WasmExecJsPath}}"></script>
<input id = "wasmBundlePathField" type=hidden value="{{.WasmBundlePath}}" />
<!-- Include generated JS for GameViewerPageMobile -->
{{# include "gen/GameViewerPage/index_Mobile.html" #}}
{{ end }}

{{ define "GameViewerPageMobile" }}
{{ template "BasePage" . }}
{{ end }}

